.nh
.TH authpf-api.conf(5) - Configuration file for authpf-api
.SH NAME
\fBauthpf-api.conf\fP — configuration file for authpf-api

.SH DESCRIPTION
The \fBauthpf-api.conf\fP file is a YAML-formatted configuration file for \fBauthpf-api(8)\fR\&. It defines all operational parameters including server settings, authentication, pf rule management, and role-based access control.

.PP
The default location is \fB/usr/local/etc/authpf-api.conf\fR\&. An alternative path can be specified via the \fBCONFIG_FILE\fR environment variable.

.SH CONFIGURATION SECTIONS
.SS defaults
Global default settings applied across the application.

.PP
\fBpfctlBinary\fP
  Path to the \fBpfctl(8)\fR binary executable. Must be accessible by the user
  running \fBauthpf-api(8)\fR\&. \fI(string, required)\fP

.SS authpf
AuthPF-specific configuration for rule management and timeouts.

.PP
\fBtimeout\fP
  Maximum timeout for authpf anchors. Defines how long pf rules remain
  active before the scheduler removes them. Supports duration formats
  like 30m, 1h, 2d. \fI(string, required)\fP

.PP
\fBuserRulesRootFolder\fP
  Root directory where user-specific rule files are stored.
  Each user gets a subdirectory here. Must be readable and writable by
  the user running \fBauthpf-api(8)\fR\&. \fI(string, required)\fP

.PP
\fBuserRulesFile\fP
  Filename for user rules within the userRulesRootFolder. This file is
  loaded when a user activates their anchors. \fI(string, required)\fP

.PP
\fBanchorName\fP
  Name of the PF anchor to use for rule management. Used to organize and
  manage rules within the packet filter. Must match the anchor name
  configured in \fB/etc/pf.conf\fR\&. \fI(string, required)\fP

.PP
\fBflushFilter\fP
  List of flush targets for \fBpfctl(8)\fR commands. Specifies which rule
  types to clear when flushing. \fI(array of strings, required)\fP
  Valid values:
    \fBnat\fR
    \fBqueue\fR
    \fBethernet\fR
    \fBrules\fR
    \fBinfo\fR
    \fBSources\fR
    \fBReset\fR

.PP
\fBonStartup\fP
  Specifies the startup anchor loading behavior \fI(string, optional)\fP\&.
  Valid values:
    \fBnone\fR - Do not import anchors on startup (default)
    \fBimport\fR - Import existing anchors from pf.
      Parses output of \fBpfctl -sA\fR and imports all existing anchors
      matching the pattern authpf/NAME(USERID).
    \fBimportflush\fR - Same as import, but removes/flushes anchors
      immediately after importing to achieve a clean state for startup.

.PP
\fBLimitations:\fP
  1. UserIP macro value cannot be detected during import.
    It will be set to "NaN/imported" and has no effect.
  2. Expire datetime is calculated using \fBauthpf.timeout\fR and current
    server time.

.PP
\fBonShutdown\fP
  Specifies behavior when the API server shuts down.
  Valid values:
    \fBnone\fR - Do nothing (default)
    \fBflushall\fR - Remove all activated user rules when the API server
      shuts down

.SS server
Server configuration including network binding, SSL/TLS, and authentication.

.PP
\fBbind\fP
  IP address to bind the server to. Use \fB127.0.0.1\fR for localhost only,
  or \fB0.0.0.0\fR to listen on all interfaces. \fI(string, required)\fP

.PP
\fBport\fP
  Port number for the HTTP/HTTPS server. Ensure the port is not already in use
  and that the firewall allows access. \fI(integer, required)\fP

.PP
\fBssl\fP
  SSL/TLS configuration for HTTPS support. \fI(object, optional)\fP

.PP
\fBcertificate\fP
    Path to SSL certificate file. Leave empty to disable SSL and use
    HTTP only. Required for HTTPS connections. \fI(string, optional)\fP

.PP
\fBkey\fP
    Path to SSL private key file. Must match the certificate and be
    readable by the server process.
    Required if certificate is specified. \fI(string, optional)\fP

.PP
\fBjwtSecret\fP
  JWT secret key for token signing. MUST be changed before production
  deployment. Use a strong, random value for security. If not set or empty,
  a random secret will be generated automatically.
  \fBWARNING:\fR Using the default or a weak secret compromises security.
  \fI(string, optional)\fP

.PP
\fBjwtTokenTimeout\fP
  JWT token timeout in hours. Determines how long authentication tokens
  remain valid.
  Default is 8 hours if not set. \fI(integer, optional)\fP

.PP
\fBelevatorMode\fP
  Elevator mode for privilege escalation. Required when running
  \fBauthpf-api(8)\fR as a non-root user. \fI(string, optional)\fP
  Valid values:
    \fBnone\fR — No privilege escalation (default).
      Only use if running as root.
    \fBsudo\fR — Use \fBsudo(8)\fR for privilege escalation.
      Requires appropriate sudoers configuration.
    \fBdoas\fR — Use \fBdoas(1)\fR for privilege escalation.
      Requires appropriate doas.conf configuration.

.PP
\fBlogfile\fP
  Path to the server logfile. Ensure the directory exists and is writable
  by the server process.
  Use \fB-foreground\fR flag to log to stdout instead. \fI(string, required)\fP

.PP
\fBrbac\fP
  Role-Based Access Control configuration for users and permissions.

.PP
\fBroles\fP
  Role definitions with associated permissions. Each role defines what
  actions users with that role can perform. \fI(object, required)\fP

.PP
\fBusers\fP
  User account definitions with credentials and role assignments.
  Each user entry includes a  password hash, assigned role,
  and optional numeric user ID. \fI(object, required)\fP

.SH AVAILABLE RBAC PERMISSIONS
.IP \(bu 2
\fBactivate_own_rules\fR - Allow user to activate their own authpf rules
.IP \(bu 2
\fBactivate_other_rules\fR - Allow user to activate rules from other users
.IP \(bu 2
\fBdeactivate_own_rules\fR - Allow user to deactivate their own rules
.IP \(bu 2
\fBdeactivate_other_rules\fR - Allow user to deactivate rules from other users
.IP \(bu 2
\fBview_own_rules\fR - Allow user to view their own rules status
.IP \(bu 2
\fBview_other_rules\fR - Allow user to view rules status from other users

.SH PASSWORD GENERATION
User passwords must be hashed using bcrypt. Generate a password hash using:

.EX
authpf-api -gen-user-password
Enter password:
$2a$10$N9qo8uLOickgx2ZM.......
.EE

.PP
Or via pipe:

.EX
echo -n "your-password" | authpf-api -gen-user-password
$2a$10$N9qo8uLOickgx2ZM.......
.EE

.PP
Copy the generated hash and add it to the configuration file.

.SH ELEVATOR SETUP
When running \fBauthpf-api\fP as a non-root user, an elevator setup is required. \fBauthpf-api\fP supports both \fBsudo(8)\fR and \fBdoas(1)\fR\&.

.SS Configure Sudo
Add the following to the sudoers file:

.EX
Cmnd_Alias AUTHPF_API_COMMANDS = /sbin/pfctl -sA, \\
    /sbin/pfctl ^-a authpf/([a-zA-Z0-9_-]+)(\\([0-9]+\\))? \\
        -D user_ip=[0-9.]+ -D user_id=[0-9]+ \\
        -f /etc/authpf/users/[a-zA-Z0-9_-]+/authpf.rules$, \\
    /sbin/pfctl ^-a authpf/([a-zA-Z0-9_-]+)(\\([0-9]+\\))? -F nat$, \\
    /sbin/pfctl ^-a authpf/([a-zA-Z0-9_-]+)(\\([0-9]+\\))? -F rules$, \\
    /sbin/pfctl ^-a authpf/([a-zA-Z0-9_-]+)(\\([0-9]+\\))? -F queue$, \\
    /sbin/pfctl ^-a authpf/([a-zA-Z0-9_-]+)(\\([0-9]+\\))? -F states$, \\
    /sbin/pfctl ^-a authpf/([a-zA-Z0-9_-]+)(\\([0-9]+\\))? -F Tables$, \\
    /sbin/pfctl ^-a authpf/([a-zA-Z0-9_-]+)(\\([0-9]+\\))? -F all$
%_authpf-api ALL=(root)  NOPASSWD: AUTHPF_API_COMMANDS
.EE

.SS Configure Doas
Add the following to \fB/etc/doas.conf\fR:

.EX
permit nopass :authpf as root cmd /sbin/pfctl
.EE

.SH EXAMPLES
.SS Minimal Configuration
.EX
defaults:
  pfctlBinary: /sbin/pfctl

authpf:
  timeout: 30m
  userRulesRootFolder: /etc/authpf/users
  userRulesFile: authpf.rules
  anchorName: authpf
  flushFilter:
    - nat
    - rules
  onStartup: none
  onShutdown: none

server:
  bind: 127.0.0.1
  port: 8080
  logfile: /var/log/authpf-api.log

rbac:
  roles:
    user:
      permissions:
        - activate_own_rules
        - deactivate_own_rules
        - view_own_rules
  users:
    authpf-user1:
      password: $2a$10$abcdefg.....
      role: user
.EE

.SS Production Configuration with SSL and Sudo
.EX
defaults:
  pfctlBinary: /sbin/pfctl

authpf:
  timeout: 1h
  userRulesRootFolder: /etc/authpf/users
  userRulesFile: authpf.rules
  anchorName: authpf
  flushFilter:
    - nat
    - queue
    - rules
  onStartup: importflush
  onShutdown: flushall

server:
  bind: 0.0.0.0
  port: 443
  ssl:
    certificate: /etc/ssl/certs/authpf-api.crt
    key: /etc/ssl/private/authpf-api.key
  jwtSecret: your-strong-random-secret-here
  jwtTokenTimeout: 12
  elevatorMode: sudo
  logfile: /var/log/authpf-api.log

rbac:
  roles:
    admin:
      permissions:
        - activate_own_rules
        - activate_other_rules
        - deactivate_own_rules
        - deactivate_other_rules
        - view_own_rules
        - view_other_rules
    user:
      permissions:
        - activate_own_rules
        - deactivate_own_rules
        - view_own_rules
  users:
    authpf-admin:
      password: $2a$10$abcdefg.....
      role: admin
      userId: 1000
    authpf-user1:
      password: $2a$10$hijklmni.....
      role: user
      userId: 1001
.EE

.SH FILES
.IP \(bu 2
\fB/usr/local/etc/authpf-api.conf\fR — Default configuration file location
.IP \(bu 2
\fB/etc/authpf/users\fR — Default root directory for user-specific rule files
.IP \(bu 2
\fB/etc/pf.conf\fR — Packet filter configuration file
.IP \(bu 2
\fB/var/log/authpf-api.log\fR — Default logfile location

.SH ENVIRONMENT
.IP \(bu 2
\fBCONFIG_FILE\fR — Override the default configuration file path
.IP \(bu 2
\fBLOG_LEVEL\fR — Set the logging level (debug, info, warn, error)

.SH SEE ALSO
.IP \(bu 2
\fBauthpf-api(8)\fR
.IP \(bu 2
\fBauthpf(8)\fR
.IP \(bu 2
\fBpfctl(8)\fR
.IP \(bu 2
\fBpf(4)\fR
.IP \(bu 2
\fBpf.conf(5)\fR
.IP \(bu 2
\fBsudo(8)\fR
.IP \(bu 2
\fBdoas(1)\fR

.SH HISTORY
The \fBauthpf-api.conf\fP configuration file format was introduced with \fBauthpf-api(8)\fR as a YAML-based alternative to traditional shell-based authpf configuration.

.SH AUTHORS
bofh@scd-systems.net
